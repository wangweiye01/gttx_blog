<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>杭州管通天下科技有限公司</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="杭州管通天下科技有限公司">
<meta property="og:url" content="https://wangweiye01.github.io/gttx_blog/index.html">
<meta property="og:site_name" content="杭州管通天下科技有限公司">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="管通天下技术团队">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/gttx_blog/atom.xml" title="杭州管通天下科技有限公司" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/gttx_blog/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/gttx_blog/css/style.css">

  
    
<link rel="stylesheet" href="/gttx_blog/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/gttx_blog/" id="logo">杭州管通天下科技有限公司</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/gttx_blog/" id="subtitle">求知若渴，虚心若愚</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/gttx_blog/">Home</a>
        
          <a class="main-nav-link" href="/gttx_blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/gttx_blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://wangweiye01.github.io/gttx_blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-date-format" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/gttx_blog/2022/04/16/date-format/" class="article-date">
  <time class="dt-published" datetime="2022-04-16T03:12:16.000Z" itemprop="datePublished">2022-04-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/gttx_blog/2022/04/16/date-format/">Java新API的时间格式化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>时间过得真是快，现在已经是2022年了。作为开发来说，时间处理是非常繁琐的。从Java 8开始有了新的时间API、时间的处理更加优雅，不再需要借助三方类库，而且线程安全。今天来梳理一下新API的格式化</p>
<h2 id="新API的时间格式化"><a href="#新API的时间格式化" class="headerlink" title="新API的时间格式化"></a>新API的时间格式化</h2><p>新的时间API的时间格式化由<code>java.time.format.DateTimeFormatter</code>负责</p>
<h3 id="本地化时间"><a href="#本地化时间" class="headerlink" title="本地化时间"></a>本地化时间</h3><p>结合枚举<code>FormatStyle</code>定义的风格，<code>DateTimeFormatter</code>预定义了基于本地（<code>Local</code>）风格的时间格式。我们来看这段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String format = DateTimeFormatter.ofLocalizedDateTime(FormatStyle.MEDIUM).format(ZonedDateTime.now());</span><br></pre></td></tr></table></figure>

<p>如果你在中国，格式化结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2022</span>年<span class="number">1</span>月<span class="number">6</span>日 下午<span class="number">4</span>:<span class="number">22</span>:<span class="number">01</span></span><br></pre></td></tr></table></figure>

<p>如果你在美国：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Jan <span class="number">6</span>, <span class="number">2022</span>, <span class="number">4</span>:<span class="number">21</span>:<span class="number">10</span> PM</span><br></pre></td></tr></table></figure>

<p>有三个静态方法及其重载来格式化本地化时间，具体已经整了成了思维导图：</p>
<p><img src="https://gttx-test.guan2018.com/20220106163219-20220416.png" alt="格式化时间图"></p>
<h3 id="ISO-RFC规范格式"><a href="#ISO-RFC规范格式" class="headerlink" title="ISO/RFC规范格式"></a>ISO/RFC规范格式</h3><p><code>DateTimeFormatter</code>还内置了<strong>ISO</strong>和<strong>RFC</strong>的时间格式，基于内置的<code>DateTimeFormatter</code>静态实现。举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 静态实例</span></span><br><span class="line">DateTimeFormatter isoWeekDateFormatter = DateTimeFormatter.ISO_WEEK_DATE;</span><br><span class="line"><span class="comment">// 执行格式化</span></span><br><span class="line">String format = isoWeekDateFormatter.format(LocalDateTime.now());</span><br><span class="line"><span class="comment">// format = 2022-W01-4</span></span><br></pre></td></tr></table></figure>

<p>其他的如下表格所示：</p>
<p><img src="https://gttx-test.guan2018.com/20220106173226-2022041602.png"></p>
<h3 id="范式格式化"><a href="#范式格式化" class="headerlink" title="范式格式化"></a>范式格式化</h3><p>这种方式应该是我们最常用的方式了。通过字母和符号构建一个范式(Patterns)，使用<code>ofPattern(String)</code>或者<code>ofPattern(String, Locale)</code>方式传递构建的范式。例如,<code>d MMM uuuu</code>将把<code>2011-12-03</code>格式化为<code>2011年12月3日</code>。从一个模式中创建的格式可以根据需要多次使用，它是不可改变的，并且是线程安全的。</p>
<p>相信什么<code>yyyy-MM-dd HH:mm:ss</code>你都玩腻了，下面给你看点没有见过的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 最后面是两个V 不是W 单个V会报错 </span></span><br><span class="line">String pattern = <span class="string">&quot;G uuuu&#x27;年&#x27;MMMd&#x27;日&#x27; ZZZZZ VV&quot;</span>;</span><br><span class="line">String format= DateTimeFormatter.ofPattern(pattern).format(ZonedDateTime.now());</span><br><span class="line"><span class="comment">// format = 公元 2022年1月7日 +08:00 Asia/Shanghai</span></span><br></pre></td></tr></table></figure>

<p>表格给你整理好了，你试一试：</p>
<p><img src="https://gttx-test.guan2018.com/202201071254202022041603.png"></p>
<p>转载自<a target="_blank" rel="noopener" href="https://www.felord.cn/new-date-formatter.html">@felord.cn</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wangweiye01.github.io/gttx_blog/2022/04/16/date-format/" data-id="cl21bl1fq0000jk6k05g5617o" data-title="Java新API的时间格式化" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-mysql-transaction-isolation" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/gttx_blog/2022/01/18/mysql-transaction-isolation/" class="article-date">
  <time class="dt-published" datetime="2022-01-18T05:47:33.000Z" itemprop="datePublished">2022-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/gttx_blog/2022/01/18/mysql-transaction-isolation/">mysql隔离性</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>事务四个特性：原子性 一致性 隔离性 持久性，下面详细介绍事务的隔离性</p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>与原子性、持久性侧重于研究事务本身不同，隔离性研究的是不同事务之间的相互影响。隔离性是指，事务内部的操作与其他事务是隔离的，并发执行的各个事务之间不能互相干扰。严格的隔离性，对应了事务隔离级别中的 <strong>Serializable(可串行化)</strong> 但实际应用中出于性能方面的考虑很少会使用可串行化。</p>
<h2 id="锁机制"><a href="#锁机制" class="headerlink" title="锁机制"></a>锁机制</h2><p>首先来看两个事务的写操作之间的相互影响。隔离性要求同一时刻只能有一个事务对数据进行写操作，InnoDB通过锁机制来保证这一点。</p>
<p>锁机制的基本原理可以概括为：事务在修改数据之前，需要先获得相应的锁；获得锁之后，事务便可以修改数据；该事务操作期间，这部分数据是锁定的，其他事务如果需要修改数据，需要等待当前事务提交或回滚后释放锁。</p>
<h3 id="行锁与表锁"><a href="#行锁与表锁" class="headerlink" title="行锁与表锁"></a>行锁与表锁</h3><p>按照粒度，锁可以分为表锁、行锁以及其他位于两者之间的锁。表锁在操作数据时会锁定整张表，并发性能较差；行锁则只锁定需要操作的数据，并发性能好。但是由于加锁本身需要消耗资源（获得锁、检查锁、释放锁等都需要消耗资源），因此在锁定数据较多情况下使用表锁可以节省大量资源。MySQL中不同的存储引擎支持的锁是不一样的，例如MyIsam只支持表锁，而InnoDB同时支持表锁和行锁，且出于性能考虑，绝大多数情况下使用的都是行锁。</p>
<h3 id="如何查看锁信息"><a href="#如何查看锁信息" class="headerlink" title="如何查看锁信息"></a>如何查看锁信息</h3><p>有多种方法可以查看InnoDB中锁的情况，例如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.innodb_locks; #锁的概况</span><br><span class="line"><span class="keyword">show</span> engine innodb status; #InnoDB整体状态，其中包括锁的情况</span><br></pre></td></tr></table></figure>

<p>下面来看一个例子：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#在事务A中执行：</span><br><span class="line"><span class="keyword">start</span> transaction;</span><br><span class="line">update account <span class="keyword">SET</span> balance <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">#在事务B中执行：</span><br><span class="line"><span class="keyword">start</span> transaction;</span><br><span class="line">update account <span class="keyword">SET</span> balance <span class="operator">=</span> <span class="number">2000</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>此时查看锁的情况：<br><img src="https://gttx-test.guan2018.com/20210118140916.png"></p>
<p>show engine innodb status查看锁相关的部分：<br><img src="https://gttx-test.guan2018.com/20210118141123.png"></p>
<p>通过上述命令可以查看事务24052和24053占用锁的情况；其中lock_type为RECORD，代表锁为行锁(记录锁)；lock_mode为X，代表排它锁(写锁)。</p>
<h3 id="脏读、不可重复读和幻读"><a href="#脏读、不可重复读和幻读" class="headerlink" title="脏读、不可重复读和幻读"></a>脏读、不可重复读和幻读</h3><p>首先来看并发情况下，读操作可能存在的三类问题：</p>
<ol>
<li>脏读：当前事务(A)中可以读到其他事务(B)未提交的数据，这种现象就是脏读。举例如下(以账户余额表为例)：</li>
</ol>
<p><img src="https://gttx-test.guan2018.com/1174710-20190128201003630-2050662608-%E8%84%8F%E8%AF%BB.png"></p>
<ol start="2">
<li>不可重复读：在事务A中先后两次读取同一数据，两次读取的结果不一样，这种现象成为不可重复读。脏读与不可重复读的区别在于：前者读到的是其他事务未提交的数据，后者读到的是其他事务已提交的数据。举例如下：</li>
</ol>
<p><img src="https://gttx-test.guan2018.com/1174710-20190128201011603-1317894910-%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB.png"></p>
<ol start="3">
<li>幻读：在事务A中按照某个条件先后两次查询数据库，两次查询结果的条数不同，这种现象称为幻读。不可重复读与幻读的区别可以通俗的理解为：前者数据变了，后者是数据的行数变了。举例如下：</li>
</ol>
<p><img src="https://gttx-test.guan2018.com/1174710-20190128201021606-1089980279-%E5%B9%BB%E8%AF%BB.png"></p>
<h2 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h2><p>SQL标准中定义了四种隔离级别，并规定了每种隔离级别下上述几个问题是否存在。一般来说，隔离级别越低，系统开销越低，可支持的并发越高，但隔离性也越差。隔离级别与读问题的关系如下：</p>
<p><img src="https://gttx-test.guan2018.com/1174710-20190128201034603-681355962-%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB.png"></p>
<p>在实际应用中 <strong>读未提交</strong> 在并发时会导致很多问题，而性能相对于其他隔离级别提高缺很有限，因此使用较少 <strong>可串行化</strong> 强制事务串行，并发效率很低，只有当数据一致性要求极高且可以接受没有并发时使用，因此使用也较少。因此在大多数数据库系统中，默认的隔离级别是 <strong>读已提交(如Oracle)</strong> 或 <strong>可重复读(后文简称RR)</strong></p>
<p>可以通过如下两个命令分别查看全局隔离级别和本次会话的隔离级别：</p>
<p><img src="https://gttx-test.guan2018.com/1174710-20190128201103652-719570401%E5%85%A8%E5%B1%80%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB.png"></p>
<p><img src="https://gttx-test.guan2018.com/1174710-20190128201111615-210490190%E4%BC%9A%E8%AF%9D%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB.png"></p>
<p>InnoDB默认的隔离级别是RR，后文会重点介绍RR。需要注意的是，在SQL标准中，RR是无法避免幻读问题的，但是InnoDB实现的RR避免了幻读问题。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wangweiye01.github.io/gttx_blog/2022/01/18/mysql-transaction-isolation/" data-id="cl21bo5eo0000pc6k780adil4" data-title="mysql隔离性" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/gttx_blog/tags/mysql/" rel="tag">mysql</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-load" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/gttx_blog/2021/11/15/load/" class="article-date">
  <time class="dt-published" datetime="2021-11-15T02:43:57.000Z" itemprop="datePublished">2021-11-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/gttx_blog/2021/11/15/load/">java加载顺序</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123; <span class="comment">// 1.第一步，准备加载类</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Main(); <span class="comment">// 4.第四步，执行main方法，new一个类，但在new之前要处理匿名代码块</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> num = <span class="number">4</span>; <span class="comment">// 2.第二步，静态变量和静态代码块的加载顺序由编写先后决定</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        num += <span class="number">3</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;b&quot;</span>); <span class="comment">// 5.第五步，按照顺序加载匿名代码块，代码块中有打印</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">5</span>; <span class="comment">// 6.第六步，按照顺序加载变量</span></span><br><span class="line"></span><br><span class="line">    &#123; <span class="comment">// 成员变量第三个</span></span><br><span class="line">        System.out.println(<span class="string">&quot;c&quot;</span>); <span class="comment">// 7.第七步，按照顺序打印c</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Main() &#123; <span class="comment">// 类的构造函数，第四个加载</span></span><br><span class="line">        System.out.println(<span class="string">&quot;d&quot;</span>); <span class="comment">// 8.第八步，最后加载构造函数，完成对象的建立</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123; <span class="comment">// 3.第三步，静态块，然后执行静态代码块，因为有输出，故打印a</span></span><br><span class="line">        System.out.println(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="comment">// 静态方法，调用的时候才加载 注意看，e没有加载</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;e&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行以上代码可以总结加载顺序：静态代码块（静态变量） -&gt; 匿名代码块（成员变量） -&gt; 构造方法 -&gt; 静态方法（不调用不加载</strong></p>
<ul>
<li>静态代码块只加载一次</li>
<li>静态方法只有调用才会加载</li>
<li>静态代码块和静态变量按照代码编写前后顺序执行</li>
<li>匿名代码块和成员变量按照代码编写前后顺序执行</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Print</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Print</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        System.out.println(s + <span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Print obj1 = <span class="keyword">new</span> Print(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Print obj2 = <span class="keyword">new</span> Print(<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Print obj3 = <span class="keyword">new</span> Print(<span class="string">&quot;3&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> Print(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Print obj4 = <span class="keyword">new</span> Print(<span class="string">&quot;5&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Print obj5 = <span class="keyword">new</span> Print(<span class="string">&quot;6&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Parent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Print(<span class="string">&quot;7&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword">extends</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> Print(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Print obj1 = <span class="keyword">new</span> Print(<span class="string">&quot;b&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Print obj2 = <span class="keyword">new</span> Print(<span class="string">&quot;c&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Child</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Print(<span class="string">&quot;d&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Print obj3 = <span class="keyword">new</span> Print(<span class="string">&quot;e&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Print obj4 = <span class="keyword">new</span> Print(<span class="string">&quot;f&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Parent obj1 = <span class="keyword">new</span> Child();</span><br><span class="line"></span><br><span class="line">        Parent obj2 = <span class="keyword">new</span> Child();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行main方法打印顺序：1 3 4 5 a b e 2 6 7 c f d 2 6 7 c f d</strong></p>
<ul>
<li>先执行父类的静态代码块和静态变量初始化，并且静态代码块和静态变量的执行顺序只跟代码中出现的顺序有关；</li>
<li>执行子类的静态代码块和静态变量初始化；</li>
<li>执行父类的实例变量初始化；</li>
<li>执行父类的构造函数；</li>
<li>执行子类的实例变量初始化；</li>
<li>执行子类的构造函数；</li>
</ul>
<p>如果类已经被加载，则静态代码块和静态变量就不用重复执行，再创建类对象时，只执行与实例相关变量初始化和构造方法</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wangweiye01.github.io/gttx_blog/2021/11/15/load/" data-id="cl21bp8jy0000rm6k86hv1cx2" data-title="java加载顺序" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/gttx_blog/2021/03/24/hello-world/" class="article-date">
  <time class="dt-published" datetime="2021-03-24T10:24:25.121Z" itemprop="datePublished">2021-03-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/gttx_blog/2021/03/24/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wangweiye01.github.io/gttx_blog/2021/03/24/hello-world/" data-id="ckmojslue0003va6k8twy8js0" data-title="Hello World" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-browser-cache" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/gttx_blog/2021/03/24/browser-cache/" class="article-date">
  <time class="dt-published" datetime="2021-03-24T02:03:36.000Z" itemprop="datePublished">2021-03-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/gttx_blog/2021/03/24/browser-cache/">浏览器缓存机制</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>浏览器缓存是前端开发中不可避免的问题，对于web应用来说，它是提升页面性能同时减少服务器压力的利器。本文将简单地描述总结下浏览器缓存的知识和应用，希望对自己和大家都有所帮助</p>
<h2 id="浏览器缓存类型"><a href="#浏览器缓存类型" class="headerlink" title="浏览器缓存类型"></a>浏览器缓存类型</h2><ul>
<li><p>强缓存<br>不会向服务器发送请求，直接从缓存中读取资源，在chrome控制台的network选项中可以看到该请求返回200的状态码，并且size显示from disk cache或from memory cache</p>
</li>
<li><p>协商缓存<br>向服务器发送请求，服务器会根据这个请求的request header的一些参数来判断是否命中协商缓存，如果命中，则返回304状态码并带上新的response header通知浏览器从缓存中读取资源</p>
</li>
</ul>
<p>两者的共同点是，都是从客户端缓存中读取资源；区别是强缓存不会发请求，协商缓存会发请求</p>
<h2 id="缓存有关的header"><a href="#缓存有关的header" class="headerlink" title="缓存有关的header"></a>缓存有关的header</h2><h3 id="强缓存"><a href="#强缓存" class="headerlink" title="强缓存"></a>强缓存</h3><p>Expires：response header里的过期时间，浏览器再次加载资源时，如果在这个过期时间内，则命中强缓存</p>
<p>Cache-Control：当值设为max-age=300时，则代表在这个请求正确返回时间（浏览器也会记录下来）的5分钟内再次加载资源，就会命中强缓存</p>
<p><img src="https://p.130014.xyz/2021/03/24/cache-control-expire.png" alt="cache-control-expire.png"></p>
<p>Expires和Cache-Control:max-age=*** 的作用是差不多的，区别就在于 Expires 是http1.0的产物，Cache-Control是http1.1的产物，两者同时存在的话，Cache-Control优先级高于Expires；在某些不支持HTTP1.1的环境下，Expires就会发挥用处。所以Expires其实是过时的产物，现阶段它的存在只是一种兼容性的写法</p>
<p>Expires和Cache-Control的区别还有一个：Expires是一个具体的服务器时间，这就导致一个问题，如果客户端时间和服务器时间相差较大，缓存命中与否就不是开发者所期望的。Cache-Control是一个时间段，控制就比较容易</p>
<h3 id="协商缓存"><a href="#协商缓存" class="headerlink" title="协商缓存"></a>协商缓存</h3><p>ETag和If-None-Match：这两个要一起说。Etag是上一次加载资源时，服务器返回的response header，是对该资源的一种唯一标识，只要资源有变化，Etag就会重新生成。浏览器在下一次加载资源向服务器发送请求时，会将上一次返回的Etag值放到request header里的If-None-Match里，服务器接受到If-None-Match的值后，会拿来跟该资源文件的Etag值做比较，如果相同，则表示资源文件没有发生改变，命中协商缓存</p>
<p>Last-Modified和If-Modified-Since：这两个也要一起说。Last-Modified是该资源文件最后一次更改时间，服务器会在response header里返回，同时浏览器会将这个值保存起来，在下一次发送请求时，放到request header里的If-Modified-Since里，服务器在接收到后也会做比对，如果相同则命中协商缓存</p>
<p><img src="https://p.130014.xyz/2021/03/24/etag-lastmodified.png" alt="etag-lastmodified.png"></p>
<p><img src="https://p.130014.xyz/2021/03/24/if-none-match.png" alt="if-none-match.png"></p>
<p>ETag和Last-Modified的作用和用法也是差不多，说一说他们的区别。<br>首先在精确度上，Etag要优于Last-Modified。Last-Modified的时间单位是秒，如果某个文件在1秒内改变了多次，那么他们的Last-Modified其实并没有体现出来修改，但是Etag每次都会改变确保了精度；如果是负载均衡的服务器，各个服务器生成的Last-Modified也有可能不一致。</p>
<p>第二在性能上，Etag要逊于Last-Modified，毕竟Last-Modified只需要记录时间，而Etag需要服务器通过算法来计算出一个hash值。<br>第三在优先级上，服务器校验优先考虑Etag</p>
<h2 id="浏览器缓存过程"><a href="#浏览器缓存过程" class="headerlink" title="浏览器缓存过程"></a>浏览器缓存过程</h2><ol>
<li><p>浏览器第一次加载资源，服务器返回200，浏览器将资源文件从服务器上请求下载下来，并把response header及该请求的返回时间一并缓存；</p>
</li>
<li><p>下一次加载资源时，先比较当前时间和上一次返回200时的时间差，如果没有超过cache-control设置的max-age，则没有过期，命中强缓存，不发请求直接从本地缓存读取该文件（如果浏览器不支持HTTP1.1，则用expires判断是否过期）；如果时间过期，则向服务器发送header带有If-None-Match和If-Modified-Since的请求；</p>
</li>
<li><p>服务器收到请求后，优先根据Etag的值判断被请求的文件有没有做修改，Etag值一致则没有修改，命中协商缓存，返回304；如果不一致则有改动，直接返回新的资源文件带上新的Etag值并返回200；</p>
</li>
<li><p>如果服务器收到的请求没有Etag值，则将If-Modified-Since和被请求文件的最后修改时间做比对，一致则命中协商缓存，返回304；不一致则返回新的last-modified和文件并返回200；</p>
</li>
</ol>
<h2 id="用户行为对浏览器缓存的控制"><a href="#用户行为对浏览器缓存的控制" class="headerlink" title="用户行为对浏览器缓存的控制"></a>用户行为对浏览器缓存的控制</h2><ol>
<li>地址栏访问，链接跳转是正常用户行为，将会触发浏览器缓存机制；</li>
<li>F5刷新，浏览器会设置max-age=0，跳过强缓存判断，会进行协商缓存判断；</li>
<li>ctrl+F5刷新，跳过强缓存和协商缓存，直接从服务器拉取资源。</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://github.com/chenjiangsong/blog/issues/1">原文链接</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wangweiye01.github.io/gttx_blog/2021/03/24/browser-cache/" data-id="ckmojslu50000va6kfcm63mfg" data-title="浏览器缓存机制" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-floyd" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/gttx_blog/2020/03/24/floyd/" class="article-date">
  <time class="dt-published" datetime="2020-03-24T07:39:41.000Z" itemprop="datePublished">2020-03-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/gttx_blog/2020/03/24/floyd/">floyd最短路径算法</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="floyd算法"><a href="#floyd算法" class="headerlink" title="floyd算法"></a>floyd算法</h2><p>弗洛伊德算法又称插点法是<strong>解决任意两点间的最短路径的一种算法</strong></p>
<h2 id="适用范围"><a href="#适用范围" class="headerlink" title="适用范围"></a>适用范围</h2><p>边权可正可负，运行一次算法即可求得任意两点间的最短路径（无负权回路即可）</p>
<p>可以解决”多源最短路径”即计算多个源点到每个点的最短路径。既然能解决多源那自然可以解决”单源最短路径”问题</p>
<h3 id="什么是负权回路"><a href="#什么是负权回路" class="headerlink" title="什么是负权回路"></a>什么是负权回路</h3><p>图中1号点到3号点的最短路径是什么？</p>
<p><img src="http://s1.wailian.download/2020/03/24/6.10.png" alt="6.10.png"></p>
<p>由于每次经过1-&gt;2-&gt;3-&gt;1这样的环，最短路径就会-1，所以永远找不到最短路径</p>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p><img src="http://s1.wailian.download/2020/03/24/6.2-floyd.png" alt="6.2-floyd.png"></p>
<p>有4个人处在1，2，3，4四个城市，为每个人规划旅行轨迹，要求每个人都能游览所有城市，并且每个人的路程都要最短</p>
<p>总结问题：计算图中各个顶点到各个顶点的最短距离</p>
<p>首先我们定义一个二维数组来存储图中最易可见的点对点(不允许经过第三点)之间的距离，如果不能到达使用∞表示。另外规定自己到自己的距离是0，具体表示如下</p>
<p><a target="_blank" rel="noopener" href="http://www.wailian.work/image/Ae1zve"><img src="http://s1.wailian.download/2020/03/24/6.3-.png" alt="6.3-.png"></a></p>
<p>如果要使两点之间距离变短，唯一方法就是通过第三个点来解决。例如a点到b点的距离通过顶点k来中转那么a-&gt;k-&gt;b才有可能缩短a-&gt;b的距离。那么这个k点是哪个点呢？是否不只通过1个k点最短，而是经过两个或者更多点最短，比如a-&gt;k1-&gt;k2&gt;b</p>
<p>比如图中4-&gt;3的距离是12，如果经过1点，那么4-&gt;1-&gt;3的距离就变为11。现在只允许经过1号点，求i点到j点的最短距离，只需判断e[i][1]+e[1][j]是否比e[i][j]要小。代码实现如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个4行4列的二维数组</span></span><br><span class="line">m = [[<span class="number">0</span>]*<span class="number">4</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为数组赋值</span></span><br><span class="line">m[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">m[<span class="number">0</span>][<span class="number">1</span>] = <span class="number">2</span></span><br><span class="line">m[<span class="number">0</span>][<span class="number">2</span>] = <span class="number">6</span></span><br><span class="line">m[<span class="number">0</span>][<span class="number">3</span>] = <span class="number">4</span></span><br><span class="line">m[<span class="number">1</span>][<span class="number">0</span>] = <span class="number">9999</span></span><br><span class="line">m[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">0</span></span><br><span class="line">m[<span class="number">1</span>][<span class="number">2</span>] = <span class="number">3</span></span><br><span class="line">m[<span class="number">1</span>][<span class="number">3</span>] = <span class="number">9999</span></span><br><span class="line">m[<span class="number">2</span>][<span class="number">0</span>] = <span class="number">7</span></span><br><span class="line">m[<span class="number">2</span>][<span class="number">1</span>] = <span class="number">9999</span></span><br><span class="line">m[<span class="number">2</span>][<span class="number">2</span>] = <span class="number">0</span></span><br><span class="line">m[<span class="number">2</span>][<span class="number">3</span>] = <span class="number">1</span></span><br><span class="line">m[<span class="number">3</span>][<span class="number">0</span>] = <span class="number">5</span></span><br><span class="line">m[<span class="number">3</span>][<span class="number">1</span>] = <span class="number">9999</span></span><br><span class="line">m[<span class="number">3</span>][<span class="number">2</span>] = <span class="number">12</span></span><br><span class="line">m[<span class="number">3</span>][<span class="number">3</span>] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;原路径数据:&#x27;</span>, m)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许经过1号点的最短路径</span></span><br><span class="line">n = copy.deepcopy(m)</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">j = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">if</span> (n[i][j] &gt; n[i][<span class="number">0</span>] + n[<span class="number">0</span>][j]):</span><br><span class="line">                n[i][j] = n[i][<span class="number">0</span>] + n[<span class="number">0</span>][j]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;在允许经过1号点后的最短路径:&#x27;</span>, n)</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<p>原路径数据: [[0, 2, 6, 4], [9999, 0, 3, 9999], [7, 9999, 0, 1], [5, 9999, 12, 0]]</p>
<p>在允许经过1号点后的最短路径: [[0, 2, 6, 4], [9999, 0, 3, 9999], [7, 9, 0, 1], [5, 7, 11, 0]]</p>
<p><img src="http://s1.wailian.download/2020/03/24/6.5-1.png" alt="6.5-1.png"></p>
<p>通过图中白色背景处我们可以看到通过1号点中转的情况下,3-&gt;2,4-&gt;2,4-&gt;3的路径都变短了</p>
<p>接下来求只允许1号和2号点的情况下任意两点间的最短距离，如何做呢？我们只需要在只经过1号点时任意两点最短距离的结果下，再判断经过2号顶点如何使i号点到j号点的路径边的更短</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 再允许经过2号点后的路径</span></span><br><span class="line">o = copy.deepcopy(n)</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">j = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">if</span>(o[i][j] &gt; o[i][<span class="number">1</span>] + o[<span class="number">1</span>][j]):</span><br><span class="line">            o[i][j] = o[i][<span class="number">1</span>] + o[<span class="number">1</span>][j]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;再允许经过2号点后的最短路径:&#x27;</span>, o)</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<p>再允许经过2号点后的最短路径: [[0, 2, 5, 4], [9999, 0, 3, 9999], [7, 9, 0, 1], [5, 7, 10, 0]]</p>
<p><img src="http://s1.wailian.download/2020/03/24/6.6-1-2.png" alt="6.6-1-2.png"></p>
<p>同理继续在只允许1，2，3进行中转的情况下求最短距离。</p>
<p><img src="http://s1.wailian.download/2020/03/24/6.7-1-2-3.png" alt="6.7-1-2-3.png"></p>
<p>最后在允许通过所有顶点作为中转，任意两点之间最终的最短路径为：</p>
<p><img src="http://s1.wailian.download/2020/03/24/6.8-1-2-3-4.png" alt="6.8-1-2-3-4.png"></p>
<p>整个算法最终代码实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">k = <span class="number">0</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">j = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            <span class="keyword">if</span> (m[i][j] &gt; m[i][k] + m[k][j]):</span><br><span class="line">                m[i][j] = m[i][k] + m[k][j]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;最终路径:&#x27;</span>, m)</span><br></pre></td></tr></table></figure>

<p>最终路径: [[0, 2, 5, 4], [9, 0, 3, 4], [6, 8, 0, 1], [5, 7, 10, 0]]</p>
<p>通过这种方法我们可以求出任意两个点之间最短路径。它的时间复杂度是 O(n<sup>3</sup>)。如果想要解决两点之间最短路径或者一个点到各个点之间的最短路径，用这个算法当然可以，但是要考虑效率有更好的算法比如Dijkstra迪杰斯特拉算法</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wangweiye01.github.io/gttx_blog/2020/03/24/floyd/" data-id="ckmojslud0002va6k55i2anmu" data-title="floyd最短路径算法" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-elasticsearch" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/gttx_blog/2020/03/21/elasticsearch/" class="article-date">
  <time class="dt-published" datetime="2020-03-21T08:02:02.000Z" itemprop="datePublished">2020-03-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/gttx_blog/2020/03/21/elasticsearch/">elasticsearch全文搜索</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="什么是Elasticsearch"><a href="#什么是Elasticsearch" class="headerlink" title="什么是Elasticsearch"></a>什么是Elasticsearch</h2><p>Elasticsearch是一个开源的，分布式，高可用的数据库，是目前<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E">全文搜索</a>的首选。它可以快速的存储、搜索、分析海量数据。</p>
<p>Elastic是基于开源库Lucene开发的，提供了REST API的操作接口，简单易用</p>
<h2 id="优秀案例"><a href="#优秀案例" class="headerlink" title="优秀案例"></a>优秀案例</h2><p>GitHub使用ElasticSearch做PB级搜索；包括但不限于维基百科、携程等成功案例；</p>
<h2 id="为什么ES全文搜索查询速度快"><a href="#为什么ES全文搜索查询速度快" class="headerlink" title="为什么ES全文搜索查询速度快"></a>为什么ES全文搜索查询速度快</h2><p>ES检索速度极快的很重要原理就是使用了<code>倒排索引</code>。什么是倒排索引？通常我们理解的索引就是通过<code>key</code>找到对应的<code>value</code>，所以通俗来讲倒排索引就是通过<code>value</code>找到对应的<code>key</code></p>
<p><img src="http://s1.wailian.download/2020/05/19/termindex.png" alt="termindex.png"></p>
<p>理解上图可以了解倒排索引的基本原理。首先ES索引时会先将文本进行分词，然后记录分词和文档的对应关系。当查询时，对查询条件同样进行分词，然后根据分词匹配对应的文档。</p>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="Node和Cluster"><a href="#Node和Cluster" class="headerlink" title="Node和Cluster"></a>Node和Cluster</h3><p>Elastic 本质上是一个分布式数据库，允许多台服务器协同工作，每台服务器可以运行多个Elastic实例</p>
<p>单个 Elastic 实例称为一个节点（node）。一组节点构成一个集群（cluster）</p>
<h3 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h3><p>索引是具有某种相似特征文档的集合。类似于MySql中的Database</p>
<h3 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h3><p>es6.x建议在一个index中保持一个type</p>
<h3 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h3><p>文档是可以被索引的基本信息单元。文档用JSON表示。类似于MySql中的一条数据(Row)</p>
<h3 id="Field"><a href="#Field" class="headerlink" title="Field"></a>Field</h3><p>属性，类似于MySql中的某个字段(Column)</p>
<h2 id="安装Elasticsearch-6-3-2"><a href="#安装Elasticsearch-6-3-2" class="headerlink" title="安装Elasticsearch(6.3.2)"></a>安装Elasticsearch(6.3.2)</h2><p>自己安装，此处选择6.3.2版本</p>
<h2 id="Kibana安装"><a href="#Kibana安装" class="headerlink" title="Kibana安装"></a>Kibana安装</h2><p>Kibana 是为 Elasticsearch设计的开源分析和可视化平台。你可以使用 Kibana 来搜索，查看存储在 Elasticsearch 索引中的数据并与之交互。你可以很容易实现高级的数据分析和可视化，以图标的形式展现出来。</p>
<p>注意与安装的Elasticsearch版本号(6.3.2)一致</p>
<h2 id="操作数据"><a href="#操作数据" class="headerlink" title="操作数据"></a>操作数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"># 新增数据1</span><br><span class="line">PUT &#x2F;person&#x2F;_doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;first_name&quot;: &quot;John&quot;,</span><br><span class="line">  &quot;last_name&quot;: &quot;Smith&quot;,</span><br><span class="line">  &quot;age&quot;: 25,</span><br><span class="line">  &quot;about&quot;: &quot;I love to go rock climbing&quot;,</span><br><span class="line">  &quot;interests&quot;: [</span><br><span class="line">    &quot;sports&quot;,</span><br><span class="line">    &quot;music&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 新增数据2</span><br><span class="line">PUT &#x2F;person&#x2F;_doc&#x2F;2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;first_name&quot;: &quot;Eric&quot;,</span><br><span class="line">  &quot;last_name&quot;: &quot;Smith&quot;,</span><br><span class="line">  &quot;age&quot;: 23,</span><br><span class="line">  &quot;about&quot;: &quot;I love basketball&quot;,</span><br><span class="line">  &quot;interests&quot;: [</span><br><span class="line">    &quot;sports&quot;,</span><br><span class="line">    &quot;reading&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 获得1</span><br><span class="line">GET &#x2F;person&#x2F;_doc&#x2F;1</span><br><span class="line"># 获得2</span><br><span class="line">GET &#x2F;person&#x2F;_doc&#x2F;2</span><br><span class="line"></span><br><span class="line"># bool搜索</span><br><span class="line">POST &#x2F;person&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;first_name&quot;: &quot;Eric&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># bool搜索</span><br><span class="line">POST &#x2F;person&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;last_name&quot;: &quot;Smith&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;about&quot;: &quot;basketball&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ik分词器"><a href="#ik分词器" class="headerlink" title="ik分词器"></a>ik分词器</h2><p><a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">ik分词器</a>是最流行的中文分词器，点击可查看ik和ES的版本对照关系以及安装方式</p>
<p>ik提供了两个分词算法<code>ik_smart</code>和<code>ik_max_word</code></p>
<p>通过以下两个图，可以看出两个算法的区别。ik_smart为智能切分，ik_max_word为最细粒度划分</p>
<p>ik_smart</p>
<p><img src="http://s1.wailian.download/2020/05/08/smart.png" alt="smart.png"></p>
<p>ik_max_word</p>
<p><img src="http://s1.wailian.download/2020/05/08/WX20200508-145012-max-word.png" alt="WX20200508-145012-max-word.png"></p>
<p>根据两个算法的区别，一般遵循以下原则：</p>
<p> <em><strong>索引时，为了提供索引的覆盖范围，通常会采用ik_max_word分析器，会以最细粒度分词索引，搜索时为了提高搜索准确度，会采用ik_smart分析器，会以粗粒度分词</strong></em></p>
<h2 id="快照创建于恢复"><a href="#快照创建于恢复" class="headerlink" title="快照创建于恢复"></a>快照创建于恢复</h2><p> 使用无论哪个存储数据的软件，定期备份你的数据都是很重要的，es提供了快照机制。你可以使用<code>snapshot</code>API。这个会拿到你集群里当前的状态和数据然后保存到一个共享仓库里。这个备份过程是”智能”的。你的第一个快照会是一个数据的完整拷贝，但是所有后续的快照会保留的是已存快照和新数据之间的差异。随着你不时的对数据进行快照，备份也在增量的添加和删除。这意味着后续备份会相当快速，因为它们只传输很小的数据量。</p>
<h3 id="创建仓库"><a href="#创建仓库" class="headerlink" title="创建仓库"></a>创建仓库</h3> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> PUT _snapshot&#x2F;my_backup ①</span><br><span class="line">&#123;</span><br><span class="line">    &quot;type&quot;: &quot;fs&quot;, ②</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;location&quot;: &quot;&#x2F;mount&#x2F;backups&#x2F;my_backup&quot; ③</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> ① 给我们的仓库取一个名字，在本例它叫 my_backup。<br> ② 我们指定仓库的类型应该是一个共享文件系统。<br> ③ 最后，我们提供一个已挂载的设备作为目的地址。注意：共享文件系统路径必须确保集群所有节点都可以访问到。</p>
<h3 id="创建快照"><a href="#创建快照" class="headerlink" title="创建快照"></a>创建快照</h3><p> 一个仓库可以包含多个快照。每个快照跟一系列索引相关（比如所有索引，一部分索引，或者单个索引）。当创建快照的时候，你指定你感兴趣的索引然后给快照取一个唯一的名字。</p>
<h4 id="快照所有打开的索引"><a href="#快照所有打开的索引" class="headerlink" title="快照所有打开的索引"></a>快照所有打开的索引</h4><p> 让我们从最基础的快照命令开始：</p>
<p> <code>PUT _snapshot/my_backup/snapshot_1</code></p>
<p> 这个会备份所有打开的索引到 my_backup 仓库下一个命名为 snapshot_1 的快照里。这个调用会立刻返回，然后快照会在后台运行。如果你想阻塞调用直到快照完成可以添加<code>wait_for_completion</code>标记实现</p>
<p><code>PUT _snapshot/my_backup/snapshot_1?wait_for_completion=true</code></p>
<h4 id="快照指定索引"><a href="#快照指定索引" class="headerlink" title="快照指定索引"></a>快照指定索引</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT _snapshot&#x2F;my_backup&#x2F;snapshot_2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;indices&quot;: &quot;index_1,index_2&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个快照命令现在只会备份<code>index1</code>和<code>index2</code>了。</p>
<h3 id="获取快照信息"><a href="#获取快照信息" class="headerlink" title="获取快照信息"></a>获取快照信息</h3><p>获取某个仓库下所有快照信息</p>
<p><code>GET _snapshot/my_backup/_all</code></p>
<p>获取某个仓库下单个快照信息</p>
<p><code>GET _snapshot/my_backup/snapshot_2</code></p>
<p>响应</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;snapshots&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;snapshot&quot;</span>: <span class="string">&quot;snapshot_202005080945&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;version_id&quot;</span>: <span class="number">2030599</span>,</span><br><span class="line">            <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;2.3.5&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;indices&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;pipe&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;state&quot;</span>: <span class="string">&quot;SUCCESS&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;start_time&quot;</span>: <span class="string">&quot;2020-05-08T01:45:57.540Z&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;start_time_in_millis&quot;</span>: <span class="number">1588902357540</span>,</span><br><span class="line">            <span class="attr">&quot;end_time&quot;</span>: <span class="string">&quot;2020-05-08T01:45:57.586Z&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;end_time_in_millis&quot;</span>: <span class="number">1588902357586</span>,</span><br><span class="line">            <span class="attr">&quot;duration_in_millis&quot;</span>: <span class="number">46</span>,</span><br><span class="line">            <span class="attr">&quot;failures&quot;</span>: [],</span><br><span class="line">            <span class="attr">&quot;shards&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="删除快照"><a href="#删除快照" class="headerlink" title="删除快照"></a>删除快照</h3><p><code>DELETE _snapshot/my_backup/snapshot_2</code></p>
<h3 id="使用快照恢复数据"><a href="#使用快照恢复数据" class="headerlink" title="使用快照恢复数据"></a>使用快照恢复数据</h3><p>快照的目的就是为了备份，为了恢复。一旦你备份过了数据，恢复它就简单了：只要在你希望恢复回集群的快照 ID后面加上<code>_restore</code>即可</p>
<p><code>POST _snapshot/my_backup/snapshot_1/_restore</code></p>
<p>默认行为是把这个快照里存有的所有索引都恢复。如果<code>snapshot_1包括五个索引，这五个都会被恢复到我们集群里。和</code>snapshot`API 一样，我们也可以选择希望恢复具体哪个索引。</p>
<p>还有附加的选项用来重命名索引。这个选项允许你通过模式匹配索引名称，然后通过恢复进程提供一个新名称。如果你想在不替换现有数据的前提下，恢复老数据来验证内容，或者做其他处理，这个选项很有用。让我们从快照里恢复单个索引并提供一个替换的名称：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;_snapshot&#x2F;my_backup&#x2F;snapshot_1&#x2F;_restore</span><br><span class="line">&#123;</span><br><span class="line">    &quot;indices&quot;: &quot;index_1&quot;, ①</span><br><span class="line">    &quot;rename_pattern&quot;: &quot;index_(.+)&quot;, ②</span><br><span class="line">    &quot;rename_replacement&quot;: &quot;restored_index_$1&quot; ③</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>① 只恢复<code>index_1</code>索引，忽略快照中存在的其余索引。<br>② 查找所提供的模式能匹配上的正在恢复的索引。<br>③ 然后把它们重命名成替代的模式。</p>
<p>这个会恢复<code>index_1</code>到你及群里，但是重命名成了<code>restored_index_1</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wangweiye01.github.io/gttx_blog/2020/03/21/elasticsearch/" data-id="ckmojslua0001va6kh5ble1w3" data-title="elasticsearch全文搜索" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-websocket" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/gttx_blog/2020/02/17/websocket/" class="article-date">
  <time class="dt-published" datetime="2020-02-17T01:14:19.000Z" itemprop="datePublished">2020-02-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/gttx_blog/2020/02/17/websocket/">websocket简介与实战</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><img src="https://p.130014.xyz/2020/10/14/grapes-5603367_1280.jpg" alt="grapes-5603367_1280.jpg"></p>
<h2 id="什么是websocket"><a href="#什么是websocket" class="headerlink" title="什么是websocket"></a>什么是websocket</h2><p>Websocket是一种在单个TCP连接上进行<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%85%A8%E5%8F%8C%E5%B7%A5/310007?fr=aladdin">全双工</a>通信的协议</p>
<h2 id="为什么需要websocket"><a href="#为什么需要websocket" class="headerlink" title="为什么需要websocket"></a>为什么需要websocket</h2><p>HTTP协议有一个缺陷：通信只能由客户端发起</p>
<p>这种单向请求的特点导致如果服务端出现连续状态的变化，客户端要想获知就比较麻烦，我们只能使用”轮询”模式</p>
<p>轮询的效率低，非常浪费资源（因为必须不停连接，或者 HTTP 连接始终打开）。因此，工程师们一直在思考，有没有更好的方法。WebSocket 就是这样发明的。</p>
<p><img src="http://s1.wailian.download/2020/02/17/bg2017051502.png" alt="bg2017051502.png"></p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><ol>
<li>建立在TCP协议之上，服务端的实现比较容易</li>
<li>与HTTP协议有良好的兼容。默认端口也是80和443，并且握手阶段采用HTTP协议，因此握手时不容易屏蔽，能通过各种HTTP代理服务器</li>
<li>数据格式比较轻，新能开销小，通信高效</li>
<li>可以发送文本，也可以发送二进制数据</li>
<li>没有同源限制，客户端可以与任意服务器通信</li>
<li>协议标识符是<code>ws</code>(如果加密，则为<code>wss</code>)，服务器网址就是URL</li>
</ol>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="STOMP协议"><a href="#STOMP协议" class="headerlink" title="STOMP协议"></a>STOMP协议</h3><p>STOMP即Simple Text Orientated Messaging Protocol，简单文本定向消息协议，它提供了一个可互操作的连接格式，允许STOMP客户端与任意STOMP消息代理（Broker）进行交互</p>
<h3 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocketMessageBroker</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfig</span> <span class="keyword">extends</span> <span class="title">AbstractWebSocketMessageBrokerConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureMessageBroker</span><span class="params">(MessageBrokerRegistry config)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 表示客户端订阅地址的前缀信息，也就是客户端接收服务端消息的地址的前缀信息</span></span><br><span class="line">        config.enableSimpleBroker(<span class="string">&quot;/topic&quot;</span>, <span class="string">&quot;/user&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//指服务端接收地址的前缀，意思就是说客户端给服务端发消息的地址的前缀</span></span><br><span class="line">        config.setApplicationDestinationPrefixes(<span class="string">&quot;/app&quot;</span>);</span><br><span class="line">        config.setUserDestinationPrefix(<span class="string">&quot;/user/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册STOMP端点</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStompEndpoints</span><span class="params">(StompEndpointRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addEndpoint(<span class="string">&quot;/my-websocket&quot;</span>).setAllowedOrigins(<span class="string">&quot;*&quot;</span>).withSockJS();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(App.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SimpMessagingTemplate messagingTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 1000)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">time</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 发现消息</span></span><br><span class="line">        DateFormat df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        messagingTemplate.convertAndSend(<span class="string">&quot;/topic/time&quot;</span>, df.format(<span class="keyword">new</span> Date()));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;time&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 2000)</span></span><br><span class="line">    <span class="meta">@SendToUser(&quot;/greetings&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">greeting2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        messagingTemplate.convertAndSendToUser(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;/greetings&quot;</span>, <span class="string">&quot;欢迎您，用户: 2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 2000)</span></span><br><span class="line">    <span class="meta">@SendToUser(&quot;/greetings&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">greeting1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        messagingTemplate.convertAndSendToUser(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;/greetings&quot;</span>, <span class="string">&quot;欢迎您，用户: 1&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 9000)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">notification</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 发送消息</span></span><br><span class="line">        messagingTemplate.convertAndSend(<span class="string">&quot;/topic/notification&quot;</span>, <span class="string">&quot;hello world!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h3><p>demo1和demo2都是订阅了两个topic。1个是获得服务器推送的时间，另一个是获得定向推送的消息(demo1向userId=1的用户推送，demo2向userId=2的用户推送)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=<span class="string">&quot;app&quot;</span>&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;label&gt;WebSocket连接状态:&lt;/label&gt;</span><br><span class="line">      &lt;button type=<span class="string">&quot;button&quot;</span> :disabled=<span class="string">&quot;connected&quot;</span> @click=<span class="string">&quot;connect()&quot;</span>&gt;连接&lt;/button&gt;</span><br><span class="line">      &lt;button type=<span class="string">&quot;button&quot;</span> @click=<span class="string">&quot;disconnect()&quot;</span> :disabled=<span class="string">&quot;!connected&quot;</span>&gt;断开&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div v-<span class="keyword">if</span>=<span class="string">&quot;connected&quot;</span>&gt;</span><br><span class="line">      &lt;label&gt;当前服务器时间：&#123;&#123; time &#125;&#125;&lt;/label&gt;</span><br><span class="line">      &lt;br /&gt;消息列表：</span><br><span class="line">      &lt;br /&gt;</span><br><span class="line">      &lt;hr /&gt;</span><br><span class="line">      &lt;table&gt;</span><br><span class="line">        &lt;thead&gt;</span><br><span class="line">          &lt;tr&gt;</span><br><span class="line">            &lt;th&gt;内容&lt;/th&gt;</span><br><span class="line">          &lt;/tr&gt;</span><br><span class="line">        &lt;/thead&gt;</span><br><span class="line">        &lt;tbody&gt;</span><br><span class="line">          &lt;tr v-<span class="keyword">for</span>=<span class="string">&quot;row in lala&quot;</span>&gt;</span><br><span class="line">            &lt;td&gt;&#123;&#123;row&#125;&#125;&lt;/td&gt;</span><br><span class="line">          &lt;/tr&gt;</span><br><span class="line">        &lt;/tbody&gt;</span><br><span class="line">      &lt;/table&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="comment">// @ is an alias to /src</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">&quot;Demo1&quot;</span>,</span><br><span class="line">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      stompClient: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="comment">// 连接状态</span></span><br><span class="line">      connected: <span class="literal">false</span>,</span><br><span class="line">      lala: [],</span><br><span class="line">      time: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    <span class="function"><span class="title">connect</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> socket = <span class="keyword">new</span> SockJS(<span class="string">&quot;http://localhost:8080/my-websocket&quot;</span>);</span><br><span class="line">      <span class="built_in">this</span>.stompClient = Stomp.over(socket);</span><br><span class="line">      <span class="keyword">const</span> that = <span class="built_in">this</span></span><br><span class="line">      <span class="built_in">this</span>.stompClient.connect(&#123;&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">frame</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 注册发送消息(demo1和demo2区别在于此)</span></span><br><span class="line">        that.stompClient.subscribe(<span class="string">&quot;/user/1/greetings&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">          that.lala.push(msg);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 注册推送时间回调</span></span><br><span class="line">        that.stompClient.subscribe(<span class="string">&quot;/topic/time&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">          that.time = response.body;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        that.connected = <span class="literal">true</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">disconnect</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.stompClient != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.stompClient.disconnect();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">this</span>.connected = <span class="literal">false</span>;</span><br><span class="line">      <span class="built_in">this</span>.lala = [];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>demo3是订阅后端topic，每隔一段时间推送消息给浏览器，随后浏览器显示<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/notification">Notification</a></p>
<p>并且该实例有自动重连的实现，心跳机制使用SockJS内部实现支持</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=<span class="string">&quot;app&quot;</span>&gt;</span><br><span class="line">    &lt;div&gt;服务器推送，客户端显示Notification&lt;/div&gt;</span><br><span class="line">    &lt;div&gt;WebSocket连接状态:&#123;&#123; connected &#125;&#125;&lt;/div&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;button type=<span class="string">&quot;button&quot;</span> :disabled=<span class="string">&quot;connected&quot;</span> @click=<span class="string">&quot;connect()&quot;</span>&gt;</span><br><span class="line">        连接</span><br><span class="line">      &lt;/button&gt;</span><br><span class="line">      &lt;button type=<span class="string">&quot;button&quot;</span> @click=<span class="string">&quot;disconnect()&quot;</span> :disabled=<span class="string">&quot;!connected&quot;</span>&gt;</span><br><span class="line">        断开</span><br><span class="line">      &lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="comment">// @ is an alias to /src</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">&quot;Demo3&quot;</span>,</span><br><span class="line">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      stompClient: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="comment">// 连接状态</span></span><br><span class="line">      connected: <span class="literal">false</span>,</span><br><span class="line">      socketUrl: <span class="string">&quot;http://localhost:8080/my-websocket&quot;</span>,</span><br><span class="line">      <span class="comment">// socketUrl: &quot;http://back.mac.com:8888/finance-back-websocket&quot;,</span></span><br><span class="line">      lockReconnect: <span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    <span class="function"><span class="title">showNotification</span>(<span class="params">info</span>)</span> &#123;</span><br><span class="line">      <span class="comment">// 弹窗</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">window</span>.Notification) &#123;</span><br><span class="line">        <span class="keyword">var</span> popNotice = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (Notification.permission == <span class="string">&quot;granted&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> notification = <span class="keyword">new</span> Notification(<span class="string">&quot;Hi，你好&quot;</span>, &#123;</span><br><span class="line">              body: info,</span><br><span class="line">              icon: <span class="string">&quot;https://pcoss.guan18.com/%E6%A9%98%E8%92%9C.jpeg&quot;</span>,</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            notification.onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">              notification.close()</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Notification.permission == <span class="string">&quot;granted&quot;</span>) &#123;</span><br><span class="line">          <span class="comment">// 已经授权接受通知</span></span><br><span class="line">          popNotice()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Notification.permission != <span class="string">&quot;denied&quot;</span>) &#123;</span><br><span class="line">          <span class="comment">// 未拒绝接受通知，提示用户授权</span></span><br><span class="line">          Notification.requestPermission(<span class="function"><span class="keyword">function</span> (<span class="params">permission</span>) </span>&#123;</span><br><span class="line">            popNotice()</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        alert(<span class="string">&quot;浏览器不支持Notification&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">successCallback</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;连接成功！&#x27;</span>)</span><br><span class="line">      <span class="built_in">this</span>.connected = <span class="literal">true</span></span><br><span class="line">      <span class="built_in">this</span>.stompClient.subscribe(<span class="string">&quot;/topic/notification&quot;</span>, <span class="function">(<span class="params">frame</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.showNotification(frame.body)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">reconnect</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">this</span>.lockReconnect) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">this</span>.lockReconnect = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">const</span> reconTimeout = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;重连中...&#x27;</span>)</span><br><span class="line">        <span class="built_in">this</span>.lockReconnect = <span class="literal">false</span></span><br><span class="line">        <span class="built_in">this</span>.socket = <span class="keyword">new</span> SockJS(<span class="built_in">this</span>.socketUrl)</span><br><span class="line">        <span class="built_in">this</span>.stompClient = Stomp.over(<span class="built_in">this</span>.socket)</span><br><span class="line">        <span class="built_in">this</span>.stompClient.connect(&#123;&#125;, <span class="function">(<span class="params">frame</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 连接成功，清除定时器</span></span><br><span class="line">          <span class="built_in">clearTimeout</span>(reconTimeout)</span><br><span class="line">          <span class="built_in">this</span>.successCallback()</span><br><span class="line">        &#125;, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 进行连接</span></span><br><span class="line">          <span class="built_in">this</span>.connected = <span class="literal">false</span></span><br><span class="line">          <span class="built_in">this</span>.connect()</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;, <span class="number">5000</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">connect</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> socket = <span class="keyword">new</span> SockJS(<span class="built_in">this</span>.socketUrl)</span><br><span class="line">      <span class="built_in">this</span>.stompClient = Stomp.over(socket)</span><br><span class="line">      <span class="built_in">this</span>.stompClient.connect(&#123;&#125;, <span class="built_in">this</span>.successCallback, <span class="built_in">this</span>.reconnect)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">disconnect</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.stompClient != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.stompClient.disconnect()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">this</span>.connected = <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>demo3演示<br><img src="http://s1.wailian.download/2020/02/20/Kapture-2020-02-20-at-14.13.37.gif" alt="Kapture-2020-02-20-at-14.13.37.gif"></p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/gttx/websocket">前端源码</a></p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/gttx/websocket-api">后端源码</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wangweiye01.github.io/gttx_blog/2020/02/17/websocket/" data-id="ckmojslug0004va6kffdf04gr" data-title="websocket简介与实战" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/gttx_blog/tags/mysql/" rel="tag">mysql</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/gttx_blog/tags/mysql/" style="font-size: 10px;">mysql</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/gttx_blog/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/gttx_blog/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/gttx_blog/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/gttx_blog/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/gttx_blog/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/gttx_blog/archives/2020/02/">February 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/gttx_blog/2022/04/16/date-format/">Java新API的时间格式化</a>
          </li>
        
          <li>
            <a href="/gttx_blog/2022/01/18/mysql-transaction-isolation/">mysql隔离性</a>
          </li>
        
          <li>
            <a href="/gttx_blog/2021/11/15/load/">java加载顺序</a>
          </li>
        
          <li>
            <a href="/gttx_blog/2021/03/24/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/gttx_blog/2021/03/24/browser-cache/">浏览器缓存机制</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 管通天下技术团队<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/gttx_blog/" class="mobile-nav-link">Home</a>
  
    <a href="/gttx_blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/gttx_blog/js/jquery-3.4.1.min.js"></script>



  
<script src="/gttx_blog/fancybox/jquery.fancybox.min.js"></script>




<script src="/gttx_blog/js/script.js"></script>





  </div>
</body>
</html>